name: Deploy

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Push Docker images to GHCR"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            mkdir -p ~/posts-service
            cd ~/posts-service
            
            # Находим контейнер RabbitMQ по порту 5672 или имени
            echo "Searching for RabbitMQ container..."
            RABBITMQ_CONTAINER=$(docker ps --filter "publish=5672" --format '{{.Names}}' | head -n1 || docker ps --format '{{.Names}}' | grep -i rabbitmq | head -n1 || echo "")
            if [ -z "$RABBITMQ_CONTAINER" ]; then
              echo "RabbitMQ container not found, using known IP 172.19.0.2"
              RABBITMQ_HOST="172.19.0.2"
              RABBITMQ_NETWORK=""
            else
              echo "Found RabbitMQ container: $RABBITMQ_CONTAINER"
              # Получаем сеть RabbitMQ контейнера
              RABBITMQ_NETWORK=$(docker inspect $RABBITMQ_CONTAINER --format '{{range $k, $v := .NetworkSettings.Networks}}{{$k}}{{end}}' | head -n1 || echo "")
              echo "RabbitMQ network: $RABBITMQ_NETWORK"
              # Используем имя контейнера (лучше чем IP, так как имя не меняется)
              RABBITMQ_HOST="$RABBITMQ_CONTAINER"
              echo "Will use container name: $RABBITMQ_HOST"
            fi
            
            RABBITMQ_URL="amqp://${{ secrets.RABBITMQ_USER }}:${{ secrets.RABBITMQ_PASSWORD }}@${RABBITMQ_HOST}:5672/"
            echo "RABBITMQ_URL will be set to: amqp://${{ secrets.RABBITMQ_USER }}:***@${RABBITMQ_HOST}:5672/"
            
            cat > docker-compose.yml << EOF
            services:
              postgres:
                image: postgres:15
                container_name: postgres-publications
                restart: unless-stopped
                environment:
                  POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'publications' }}
                  POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'postgres' }}
                  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - publications-network
            EOF
            
            if [ -n "$RABBITMQ_NETWORK" ] && [ "$RABBITMQ_NETWORK" != "publications-network" ]; then
              cat >> docker-compose.yml << EOF
                  - ${RABBITMQ_NETWORK}
            EOF
            fi
            
            cat >> docker-compose.yml << EOF
                ports:
                  - "5433:5432"
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U ${{ secrets.POSTGRES_USER || 'postgres' }}"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
              
              posts-service:
                image: ghcr.io/${{ github.repository_owner }}/posts-service:latest
                container_name: posts-service
                restart: unless-stopped
                depends_on:
                  postgres:
                    condition: service_healthy
                ports:
                  - "8000:8000"
                environment:
                  - DATABASE_URL=${{ secrets.DATABASE_URL }}
                  - RABBITMQ_URL=${RABBITMQ_URL}
                networks:
                  - publications-network
            EOF
            
            if [ -n "$RABBITMQ_NETWORK" ] && [ "$RABBITMQ_NETWORK" != "publications-network" ]; then
              cat >> docker-compose.yml << EOF
                  - ${RABBITMQ_NETWORK}
            EOF
            fi
            
            cat >> docker-compose.yml << EOF
            
            networks:
              publications-network:
                driver: bridge
            EOF
            
            if [ -n "$RABBITMQ_NETWORK" ] && [ "$RABBITMQ_NETWORK" != "publications-network" ]; then
              cat >> docker-compose.yml << EOF
              ${RABBITMQ_NETWORK}:
                external: true
            EOF
            fi
            
            cat >> docker-compose.yml << EOF
            
            volumes:
              postgres_data:
            EOF
            
            if [ -n "${{ secrets.GITHUB_TOKEN }}" ]; then
              echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            fi
            
            echo "Generated docker-compose.yml:"
            cat docker-compose.yml
            
            docker compose pull
            docker compose down || true
            docker compose up -d
            docker image prune -f
            
            echo "Checking posts-service environment variables:"
            docker exec posts-service env | grep RABBITMQ_URL || echo "RABBITMQ_URL not found in environment"